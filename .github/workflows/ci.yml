name: CI - Testes e ValidaÃ§Ãµes

on:
  pull_request:
    branches: 
      - develop
      - master
  workflow_dispatch:

jobs:
  tests-and-validation:
    name: Testes e Build Docker
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql

      - name: ğŸ“¦ Instalar dependÃªncias (Composer)
        run: |
          composer install --no-interaction --no-progress
          composer dump-autoload

      - name: ğŸ§ª Instalar PHPUnit
        run: composer require --dev phpunit/phpunit ^10

      - name: â³ Aguardar MySQL iniciar
        run: sleep 20

      - name: ğŸ—„ï¸ Criar schema do banco de dados
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testdb
          DB_USERNAME: root
          DB_PASSWORD: root
        run: |
          mysql -h $DB_HOST -u$DB_USERNAME -p$DB_PASSWORD $DB_DATABASE < database/schema.sql
          echo "âœ… Schema criado com sucesso!"

      - name: ğŸ§ª Rodar testes (PHPUnit)
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testdb
          DB_USERNAME: root
          DB_PASSWORD: root
        run: |
          echo "ğŸ§ª Executando testes..."
          vendor/bin/phpunit --colors=always --verbose
          echo "âœ… Todos os testes passaram!"

      - name: ğŸ³ Build Docker (validaÃ§Ã£o)
        run: |
          echo "ğŸ³ Validando build da imagem Docker..."
          docker build -t mvc-app-test:ci .
          echo "âœ… Imagem Docker construÃ­da com sucesso!"

      - name: ğŸ“Š RelatÃ³rio Final
        if: success()
        run: |
          echo "=================================="
          echo "âœ… CI PASSOU COM SUCESSO!"
          echo "=================================="
          echo "âœ“ Testes unitÃ¡rios e de integraÃ§Ã£o: OK"
          echo "âœ“ Build Docker: OK"
          echo "âœ“ Schema SQL: OK"
          echo ""
          echo "Este PR estÃ¡ pronto para ser merged! ğŸš€"

      - name: âŒ CI Falhou
        if: failure()
        run: |
          echo "=================================="
          echo "âŒ CI FALHOU!"
          echo "=================================="
          echo "Por favor, verifique os logs acima e corrija os problemas."
          echo "O merge estÃ¡ bloqueado atÃ© que todos os checks passem."
          exit 1
