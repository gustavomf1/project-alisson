name: CD - Deploy Production

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Run CI first
  ci:
    name: Run CI Pipeline
    uses: ./.github/workflows/ci.yml

  # Job 2: Build and Push Docker Image
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîê Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üè∑Ô∏è Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: üî® Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
    
    - name: ‚úÖ Docker Build Success
      run: echo "‚úÖ Docker image built and pushed successfully!"

  # Job 3: Deploy to VPS
  deploy:
    name: Deploy to VPS Locaweb
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîë Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
    
    - name: üìã Copy deployment files to VPS
      run: |
        scp -i ~/.ssh/deploy_key \
          docker-compose.yml \
          ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/opt/myburguer/
    
    - name: üóÑÔ∏è Backup MySQL Database
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/myburguer
          
          mkdir -p backups
          
          if docker ps | grep -q myburguer-mysql-prod; then
            echo "üì¶ Creating database backup..."
            BACKUP_FILE="backups/backup_$(date +%Y%m%d_%H%M%S).sql"
            docker exec myburguer-mysql-prod sh -c 'exec mysqldump -uroot -p"$MYSQL_ROOT_PASSWORD" myburguer' > $BACKUP_FILE
            echo "‚úÖ Backup created: $BACKUP_FILE"
            
            # Keep only last 7 backups
            ls -t backups/backup_*.sql | tail -n +8 | xargs -r rm
          else
            echo "‚ÑπÔ∏è No running MySQL container to backup"
          fi
        EOF
    
    - name: üê≥ Pull new Docker image
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/myburguer
          echo "üì• Pulling new Docker image..."
          
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker-compose -f docker-compose.yml pull api
          
          echo "‚úÖ Image pulled successfully"
        EOF
    
    - name: üîÑ Deploy application
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/myburguer
          echo "üîÑ Deploying application..."
          
          docker-compose -f docker-compose.yml down
          docker-compose -f docker-compose.yml up -d
          
          echo "‚úÖ Containers started"
        EOF
    
    - name: üè• Health check
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/myburguer
          
          sleep 15
          
          if ! docker-compose -f docker-compose.yml ps | grep -q "Up"; then
            echo "‚ùå Containers are not running!"
            docker-compose -f docker-compose.yml logs
            exit 1
          fi
          
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
            sleep 5
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          docker-compose -f docker-compose.yml logs api
          exit 1
        EOF
    
    - name: üßπ Cleanup
      if: always()
      run: rm -f ~/.ssh/deploy_key
    
    - name: ‚úÖ Deployment Success
      if: success()
      run: echo "üéâ Deployment successful! Application is live on ${{ secrets.VPS_HOST }}"

    - name: ‚ùå Deployment Failed
      if: failure()
      run: echo "‚ùå Deployment failed! Check VPS logs."
