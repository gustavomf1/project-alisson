name: CD - Deploy Production

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do cÃ³digo
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Configurar SSH
      - name: ğŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # 3. Copiar docker-compose.yml e cÃ³digo para VPS
      - name: ğŸ“‹ Copy deployment files to VPS
        run: |
          scp -i ~/.ssh/deploy_key -r ./* ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/opt/sistema_av_iii/

      # 4. Criar backup do banco MySQL
      - name: ğŸ—„ï¸ Backup MySQL Database
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/sistema_av_iii
            mkdir -p backups
            if docker ps | grep -q mvc_app_db; then
              echo "ğŸ“¦ Creating database backup..."
              BACKUP_FILE="backups/backup_$(date +%Y%m%d_%H%M%S).sql"
              docker exec mvc_app_db /usr/bin/mysqldump -uroot -prootpass sistema_av_iii > $BACKUP_FILE
              echo "âœ… Backup created: $BACKUP_FILE"
              # Keep only last 7 backups
              ls -t backups/backup_*.sql | tail -n +8 | xargs -r rm
            else
              echo "â„¹ï¸ No running database container to backup"
            fi
          EOF

      # 5. Deploy com Docker Compose
      - name: ğŸ”„ Deploy application
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/sistema_av_iii
            echo "ğŸ”„ Stopping old containers..."
            docker-compose down
            echo "ğŸ”„ Starting new containers..."
            docker-compose up -d --build
            echo "âœ… Containers started"
          EOF

      # 6. Health check
      - name: ğŸ¥ Health check
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/sistema_av_iii
            sleep 10
            if ! docker-compose ps | grep -q "Up"; then
              echo "âŒ Containers are not running!"
              docker-compose logs
              exit 1
            fi
            if curl -f http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
            else
              echo "âŒ Health check failed!"
              docker-compose logs
              exit 1
            fi
          EOF

      # 7. Cleanup
      - name: ğŸ§¹ Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

      # 8. Deployment Success
      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ“Œ URL: http://${{ secrets.VPS_HOST }}:8080"
