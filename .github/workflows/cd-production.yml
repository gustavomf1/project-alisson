name: CD - Deploy Production

on:
  push:
    branches: 
      - master
  workflow_dispatch:

# IMPORTANTE: Este workflow sÃ³ executa em push para master
# Garante que nada vai para produÃ§Ã£o sem passar pelo CI

jobs:
  deploy:
    name: Deploy to VPS Production
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ“‹ Sync project files to VPS
      run: |
        # Criar diretÃ³rio temporÃ¡rio excluindo arquivos desnecessÃ¡rios
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='vendor' \
          --exclude='backups' \
          --exclude='.env' \
          -e "ssh -i ~/.ssh/deploy_key" \
          ./ ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/opt/sistema_av_iii/

    - name: ğŸ—„ï¸ Backup MySQL Database
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/sistema_av_iii
          mkdir -p backups
          if docker ps | grep -q mvc_app_db; then
            BACKUP_FILE="backups/backup_$(date +%Y%m%d_%H%M%S).sql"
            docker-compose exec -T db mysqldump -uroot -prootpass sistema_av_iii > $BACKUP_FILE
            echo "âœ… Backup created: $BACKUP_FILE"
            # Keep last 7 backups
            ls -t backups/backup_*.sql | tail -n +8 | xargs -r rm
          fi
        EOF

    - name: ğŸ”¨ Build and deploy containers
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/sistema_av_iii

          echo "ğŸ”„ Stopping and removing old containers..."
          docker-compose down --remove-orphans
          
          echo "ğŸ§¹ Force removing any conflicting containers..."
          docker rm -f mvc_app_php mvc_app_web mvc_app_db 2>/dev/null || true

          echo "ğŸ”„ Building and starting all containers..."
          docker-compose up -d --build

          echo "âœ… Verifying containers are running..."
          docker-compose ps
          if ! docker-compose ps | grep "Up"; then
            echo "âŒ Containers failed to start!"
            docker-compose logs
            exit 1
          fi

          echo "â³ Waiting 30 seconds for containers to initialize..."
          sleep 30

          echo "ğŸ”„ Running database migrations..."
          docker-compose exec -T app php artisan migrate || true

          echo "ğŸ¥ Health check..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:8080/ > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
            sleep 5
          done

          echo "âŒ Health check failed!"
          echo "ğŸ“‹ Container status:"
          docker-compose ps
          echo "ğŸ“‹ Application logs:"
          docker-compose logs app
          echo "ğŸ“‹ Nginx logs:"
          docker-compose logs web
          exit 1
        EOF

    - name: ğŸ§¹ Cleanup SSH key
      if: always()
      run: rm -f ~/.ssh/deploy_key

    - name: âœ… Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ =================================="
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo "ğŸ‰ =================================="
        echo "âœ… Application deployed to: ${{ secrets.VPS_HOST }}"
        echo "âœ… Branch: ${{ github.ref_name }}"
        echo "ğŸ”— Access your application at: http://${{ secrets.VPS_HOST }}:8080"

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ =================================="
        echo "âŒ DEPLOYMENT FAILED!"
        echo "âŒ =================================="
        echo "Check the logs above for details and manually inspect the VPS if necessary."
