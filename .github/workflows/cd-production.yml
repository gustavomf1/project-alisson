name: CD - Deploy Production

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS Production
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ“‹ Copy docker-compose to VPS
      run: |
        scp -i ~/.ssh/deploy_key docker-compose.yml \
          ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/opt/sistema_av_iii/

    - name: ğŸ—„ï¸ Backup MySQL Database
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/sistema_av_iii
          mkdir -p backups
          if docker ps | grep -q mvc_app_db; then
            BACKUP_FILE="backups/backup_$(date +%Y%m%d_%H%M%S).sql"
            docker-compose exec -T db mysqldump -uroot -prootpass sistema_av_iii > $BACKUP_FILE
            echo "âœ… Backup created: $BACKUP_FILE"
            # Keep last 7 backups
            ls -t backups/backup_*.sql | tail -n +8 | xargs -r rm
          fi
        EOF

    - name: ğŸ”¨ Build and deploy app container
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd /opt/sistema_av_iii

          echo "ğŸ”„ Stopping old app container..."
          docker-compose stop app
          docker-compose rm -f app

          echo "ğŸ”„ Building and starting new app container..."
          docker-compose up -d --build app

          echo "â³ Waiting 15 seconds for app container to initialize..."
          sleep 15

          echo "ğŸ”„ Running database migrations..."
          docker-compose exec -T app php artisan migrate || true

          echo "ğŸ¥ Health check..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
            sleep 5
          done

          echo "âŒ Health check failed!"
          docker-compose logs app
          exit 1
        EOF

    - name: ğŸ§¹ Cleanup SSH key
      if: always()
      run: rm -f ~/.ssh/deploy_key

    - name: âœ… Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ =================================="
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo "ğŸ‰ =================================="
        echo "âœ… Application deployed to: ${{ secrets.VPS_HOST }}"
        echo "âœ… Branch: ${{ github.ref_name }}"
        echo "ğŸ”— Access your application at: http://${{ secrets.VPS_HOST }}:8080"

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ =================================="
        echo "âŒ DEPLOYMENT FAILED!"
        echo "âŒ =================================="
        echo "Check the logs above for details and manually inspect the VPS if necessary."
